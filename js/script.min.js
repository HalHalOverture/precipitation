const LAT=36.8,LNG=137.7;let gCurrentObjectIndex,data=null;const DESCRIPTIONS=[{dates:"default",class:"default"},{dates:"2019/06/30,2019/07/01,2019/07/02,2019/07/03,2019/07/04",class:"d01"},{dates:"2019/08/14,2019/08/15,2019/08/16",class:"d02"},{dates:"2019/08/27,2019/08/28",class:"d03"},{dates:"2019/09/08,2019/09/09",class:"d04"},{dates:"2019/10/11,2019/10/12,2019/10/13",class:"d05"},{dates:"2019/10/25,2019/10/26",class:"d06"}],deckgl=new deck.DeckGL({mapboxApiAccessToken:"pk.eyJ1IjoidGtwZmFkbWluIiwiYSI6ImNqbjJ2c2pkazMzcnAzcW84d3dpbjR2NmQifQ.dxPtzKHbhxypqtj7aZ9E2w",mapStyle:{version:8,sources:{"gsi-tiles":{type:"raster",tiles:["https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg"],attribution:'&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',tileSize:256}},layers:[{id:"simple-tiles",type:"raster",source:"gsi-tiles",minzoom:0,maxzoom:22}]},container:"map-block",longitude:LNG,latitude:LAT,zoom:5,minZoom:3,maxZoom:8,pitch:50,bearing:10,lang:"ja"}),rotateViewport=t=>{let e=deckgl.controller.props.viewState;"right"===t&&(e.bearing-=9),"left"===t&&(e.bearing+=9),"up"===t&&(e.pitch-=6),"down"===t&&(e.pitch+=6),e.pitch<0&&(e.pitch=0),e.pitch>60&&(e.pitch=60),deckgl.setProps({viewState:{longitude:e.longitude,latitude:e.latitude,zoom:e.zoom,minZoom:e.minZoom,maxZoom:e.maxZoom,pitch:e.pitch,bearing:e.bearing}})},getRGB=t=>(3==(t=t.slice(1)).length&&(t=t.slice(0,1)+t.slice(0,1)+t.slice(1,2)+t.slice(1,2)+t.slice(2,3)+t.slice(2,3)),[t.slice(0,2),t.slice(2,4),t.slice(4,6)].map(function(t){return parseInt(t,16)})),colors=[getRGB("#ddd"),getRGB("#acf"),getRGB("#79c"),getRGB("#469"),getRGB("#136"),getRGB("#862"),getRGB("#821")],renderLayer=()=>{const t=()=>{let t=$("#date-box").text().split("/");return(new Date(2019,parseInt(t[1])-1,parseInt(t[2]))-new Date(2019,0,1))/864e5},e=e=>{let a=0,o=0;for(let i=0;i<e.length;i++){let s=e[i][4].split("/"),n=t();s[n]&&(isNaN(s[n])||parseFloat(s[n])>=0&&(a+=parseFloat(s[n]),o+=1))}return o>=2&&(a/=o),a},a={lightsPosition:[139.7,34.8,2e3,135.7,38.8,2e3],ambientRatio:.4,diffuseRatio:.6,specularRatio:.2,lightsStrength:[1.3,.4,1.3,.4],numberOfLights:2},o=new deck.HexagonLayer({id:"hexagonLayer",data:data,colorRange:colors,colorDomain:[0,6],getColorValue:t=>(t=>{let a=e(t),o=0;return 1<=a&&(o=1),5<=a&&(o=2),10<=a&&(o=3),50<=a&&(o=4),100<=a&&(o=5),200<=a&&(o=6),o})(t),elevationScale:300,elevationDomain:[0,922.5],getElevationValue:t=>e(t),extruded:!0,getPosition:t=>t,autoHighlight:!0,highlightColor:[240,220,0,230],lightSettings:a,opacity:1,radius:6e3,coverage:1,pickable:!0,onClick:({x:e,y:a,object:o})=>{if(o){let e=$("#description-modal").find("section.tooltip");e.find("table").find("tbody").empty(),e.find("#tooltip-chart").empty(),gCurrentObjectIndex=o.index,points=[],o.points.forEach(function(a){points.push(a),a[2];let o=a[3],i=a[4].split("/")[t()],s="<tr><td>"+o+"</td><td>"+$("#date-box").text()+"</td><td>"+i+"<span> mm</span></td></tr>";e.find("table").find("tbody").append(s)}),(t=>{$("#tooltip-chart").html('<canvas id="chart-canvas"></canvas>');let e=[],a=new Date(2018,11,25);for(let t=0;t<365;t++)if(a.setDate(a.getDate()+1),1===a.getDate()){let t=(a.getMonth()+1).toString()+"月";e.push(t)}else e.push("");let o=["#8ad","#dfe"],i={type:"line",data:{labels:e,datasets:[]},options:{aspectRatio:1,responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{mode:"index",xPadding:24,yPadding:12,displayColors:!0,yAlign:"bottom",callbacks:{title:function(t){let e=new Date(2019,0,1);return e.setDate(e.getDate()+t[0].index),e.getFullYear()+"/"+("0"+(e.getMonth()+1).toString()).slice(-2)+"/"+("0"+e.getDate()).slice(-2)},label:function(t,e){return e.datasets[t.datasetIndex].label+"：降水量"+t.value+" mm/日"}}},scales:{xAxes:[{display:!1,gridLines:{display:!1}}],yAxes:[{location:"bottom",gridLines:{display:!0,color:"rgba(255, 255, 255, 0.3)"},ticks:{suggestedMax:1e3,suggestedMin:0,callback:function(t,e,a){if(t%200==0)return t.toString()+" mm"}}}]}}};t.forEach(function(t,e){let a={label:t[3],backgroundColor:o[e],pointRadius:1,borderWidth:1,borderColor:o[e],data:t[4].split("/")};i.data.datasets.push(a)}),t.length>=2&&(i.options.legend.display=!0);let s=document.getElementById("chart-canvas").getContext("2d");Chart.defaults.global.defaultFontColor="rgba(255, 255, 255, 0.8)",window.myChart=new Chart(s,i)})(points),$("#description-modal").find("section").removeClass("show"),$("#description-modal").find("section.tooltip").addClass("show"),$("#description-modal").addClass("show")}else $("#description-modal").removeClass("show"),gCurrentObjectIndex=-1},upperPercentile:100});deckgl.setProps({layers:[o]})},updateDescription=()=>{let t="default";DESCRIPTIONS.forEach(function(e){e.dates.split(",").forEach(function(a){$("#date-box").text()==a&&(t=e.class)})}),$("#description-modal").find("section").removeClass("show"),$("#description-modal").find("section."+t).addClass("show"),"default"===t?$("#description-button").removeClass("show"):$("#description-button").addClass("show")},init=()=>{const t=(t,e)=>{let a=$("#date-box").text().split("/"),o=new Date(2019,parseInt(a[1])-1,parseInt(a[2])),i=new Date(2019,0,1),s=new Date(2019,11,25);"next"===t&&"day"===e&&o.setDate(o.getDate()+1),"prev"===t&&"day"===e&&o.setDate(o.getDate()-1),"next"===t&&"month"===e&&o.setMonth(o.getMonth()+1),"prev"===t&&"month"===e&&o.setMonth(o.getMonth()-1),$(".input-date-button").addClass("clickable"),o<=i&&(o=i,$(".input-date-button.prev").removeClass("clickable")),o>=s&&(o=s,$(".input-date-button.next").removeClass("clickable"));let n=o.getFullYear()+"/"+("0"+(o.getMonth()+1).toString()).slice(-2)+"/"+("0"+o.getDate()).slice(-2);$("#date-box").text(n),updateDescription(),renderLayer()};d3.csv("data/data.csv",(t,e)=>{data=e.map(function(t){return[Number(t.longitude),Number(t.latitude),String(t.number),String(t.name),String(t.values)]}),renderLayer(),$("#map-cover").removeClass("show")}),$("#show-map").on("click",function(){$("#cover-block").addClass("hide")}),$(".row-disaster").on("click",function(){$("#date-box").text($(this).attr("date")),updateDescription(),renderLayer();let t=deckgl.controller.props.viewState;deckgl.setProps({viewState:{longitude:parseInt($(this).attr("lon")),latitude:parseInt($(this).attr("lat")),zoom:t.zoom,minZoom:t.minZoom,maxZoom:t.maxZoom,pitch:t.pitch,bearing:t.bearing}}),$("#description-modal").removeClass("show")}),$("#rotate-buttons").find("button").on("click",function(){let t=$(this).attr("type");rotateViewport(t)}),$("#description-button").on("click",function(){updateDescription(),$("#description-modal").addClass("show")}),$("#description-modal").find(".cover").on("click",function(){$("#description-modal").removeClass("show")}),$("#description-modal").find(".close").on("click",function(){$("#description-modal").removeClass("show")}),$(".input-date-button.clickable").on("click",function(){$(this).hasClass("next")&&($(this).hasClass("month")&&t("next","month"),$(this).hasClass("day")&&t("next","day")),$(this).hasClass("prev")&&($(this).hasClass("month")&&t("prev","month"),$(this).hasClass("day")&&t("prev","day"))})};$(function(){init()});